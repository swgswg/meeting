<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>视频会议</title>
    <!-- 通用css -->
    <link rel="stylesheet" href="./css/common.css">
    <!-- 视频会议css -->
    <link rel="stylesheet" href="./css/videoConference.css">
    <!-- uikit框架 -->
    <link rel="stylesheet" href="uikit-2.25.0/css/uikit.min.css">
    <link rel="stylesheet" href="uikit-2.25.0/css/components/notify.css">
    <link rel="stylesheet" href="uikit-2.25.0/css/components/slider.css">

    <!-- 字体图标 -->
    <link rel="stylesheet" href="//at.alicdn.com/t/font_1301614_dzaj4pp6z3k.css">

    <!-- jquery -->
    <script src="js/jquery.min.js"></script>
    <script src="js/util.js"></script>
    <script src="uikit-2.25.0/js/uikit.min.js"></script>
    <script src="uikit-2.25.0/js/components/notify.js"></script>
    <script src="uikit-2.25.0/js/components/slider.js"></script>
</head>

<body>
<div class="meetingRoom">
    <!-- 视频会议左侧 -->
    <div class="meeting-l">
        <!-- 用户列表 -->
        <div class="meeting-l-userList">
            <!-- 用户列表--头部 -->
            <div class="meeting-title">
                <div class="clearfix">
                    <i class="iconfont icon-huiyikaihuitaolun titleLogo"></i>
                    <span id="roomNum"></span>
                    <span id="userNum"></span>
                    <i class="iconfont icon-caidan titleMenu" id="menuBtn"></i>
                    <span id="roomName"></span>
                </div>
                <div class="titleMenu-dialog" id="menuDialog">
                    <div class="menu-item" id="allMute">
                        <i class="iconfont icon-maikefeng-jingyin menu-item-icon"></i>
                        <span class="menu-item-title">全体静音</span>
                    </div>
                    <div class="menu-item" id="closeMeeting">
                        <i class="iconfont icon-phonedianhua menu-item-icon"></i>
                        <span class="menu-item-title">结束会议</span>
                    </div>
                </div>
            </div>
            <!-- 用户列表--头部结束 -->
            <!-- 用户列表--列表 -->
            <div class="meeting-list">
                <ul id="userList">
                    <!-- <li> -->
                    <!-- <i class="iconfont icon-icontouxiang-copy avatar"></i> -->
                    <!-- <span id="host">主持人</span> -->
                    <!-- <span>访客</span> -->
                    <!-- <em>（我）</em> -->
                    <!-- 更多 -->
                    <!-- <i class="iconfont icon-gengduo fr more"></i> -->
                    <!-- 麦克风 -->
                    <!-- <i class="iconfont icon-maikefeng-tianchong fr voice"></i> -->
                    <!-- <i class="iconfont icon-maikefeng-jingyin-tianchongsvg"></i> -->
                    <!-- </li> -->
                </ul>
            </div>
            <script>
                $(function () {
                    // 点击菜单按钮
                    $('#menuBtn').click(function () {
                        if ($('#menuDialog').css('display') === 'none') {
                            $('#menuDialog').show()
                        } else {
                            $('#menuDialog').hide()
                        }
                    })
                    // 全体静音
                    $('#allMute').click(function () {
                        ws.send({
                            action: 'webrtc',
                            event: 'muteAudio',
                            mine: {
                                id: localUserId
                            },
                            room: {
                                id: roomId
                            },
                            auth: isAllMute // true静音/false取消静音
                        });
                        if (!isAllMute) {
                            $('#allMute .menu-item-title').text('取消静音');
                            $('#allMute .iconfont').removeClass('icon-maikefeng-jingyin').addClass('icon-maikefeng');
                        } else {
                            $('#allMute .menu-item-title').text('全体静音');
                            $('#allMute .iconfont').removeClass('icon-maikefeng').addClass('icon-maikefeng-jingyin');

                        }
                        isAllMute = !isAllMute;
                        $('.voice').each(function (){
                            var uuId = $(this).parent().attr('data-id');
                            if(uuId != roomInfo.owner){
                                if (isAllMute) {
                                    $(this).removeClass('icon-maikefeng-tianchong').addClass('icon-maikefeng-jingyin').addClass('redColor');
                                } else {
                                    $(this).removeClass('icon-maikefeng-jingyin').removeClass('redColor').addClass('icon-maikefeng-tianchong');
                                }
                            }
                        });
                    });


                    // 结束会议
                    $('#closeMeeting').click(function () {
                        var r = confirm("是否确定要关闭该会议室!!!");
                        if (r == true) {
                            ws.send({
                                action: 'webrtc',
                                event: 'closeRoom',
                                mine: {
                                    id: localUserId
                                },
                                room: {
                                    id: roomId
                                },
                            });
                            setTimeout(function () {
                                ws.close();
                            }, 1000);
                        }
                    });
                })
            </script>
        </div>

        <!-- 用户列表结束 -->
        <!-- 会议聊天 -->
        <div class="meeting-l-chat">
            <!-- 会议聊天--头部 -->
            <div class="meeting-title">
                <div class="clearfix">
                    <span>文字沟通</span>
                    <!-- <i class="iconfont icon-xia fr"></i> -->
                    <!-- <i class="iconfont icon-shang fr"></i> -->
                </div>
            </div>
            <!-- 会议聊天--头部结束 -->
            <!-- 会议聊天--会话 -->
            <div class="meeting-chatList">
                <ul id="chatList">
                    <!--<li>-->
                    <!--<span>华北扛把子：</span>-->
                    <!--<p>-->
                    <!--哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈哈-->
                    <!--</p>-->
                    <!--</li>-->
                </ul>
            </div>
            <div class="meeting-sendMessage">
                <textarea name="" id="sendMessage" cols="" rows=""></textarea>
                <i class="iconfont icon-daifasong" id="Send" onclick="Send()"></i>
            </div>
            <!-- 会议聊天--会话结束 -->
            <script>
                $(function () {
                    // 回车发送
                    $(document).keydown(function (e) {
                        if (e.keyCode == 13) {
                            Send();
                            return false;
                        }
                    });
                });

                // 点击发送
                function Send() {
                    var sendVal = $('#sendMessage').val();
                    if (sendVal == '') {
                        UIkit.notify("发送内容不能为空！", {
                            status: 'danger',
                            timeout: 1000
                        });
                        return;
                    }
                    sendChannelData({
                        userId: localUserId,
                        userName: userName,
                        content: sendVal,
                    }, 'json');
                    $('#chatList').append(`
                        <li>
                            <span>我：</span>
                            <p>
                            ${sendVal}
                            </p >
                        </li>
                    `);
                    $(".meeting-chatList").scrollTop($(".meeting-chatList")[0].scrollHeight);
                    $('#sendMessage').val('');
                };
            </script>
        </div>
        <!-- 会议聊天结束 -->


    </div>
    <!-- 视频会议左侧结束 -->

    <div class="meeting-r">
        <!-- 中间盒子 -->
        <div class="meeting-r-center">
            <!-- 一大分屏 -->
            <!-- <video class="videoStyle" src=""></video> -->
            <!-- 一大分屏结束 -->

            <!-- 4分屏 -->
            <div class="videoList-4">
                <ul class="clearfix">
                </ul>
            </div>
            <!-- 4分屏结束 -->
        </div>
        <!-- 中间盒子结束 -->
        <!-- 右上自己小分屏 -->
        <div class="myself">
            <div class="myself-videoBox">
                <video id="localVideoSmall" src="" playsinline autoplay muted></video>
            </div>
            <div class="myself-show">
                <i class="icon-zuixiaohua- iconfont v-hide" onclick="myhide()"></i>
                <i class="icon-zhankai iconfont v-hide" onclick="myShow()"></i>
            </div>
        </div>
        <script>
            // var videoSrc = './images/1.mp4';
            // $('.myself-videoBox video').attr('src', videoSrc);
            $('i.icon-zhankai').hide();

            function myhide() {
                $('.myself-videoBox').hide();
                $('i.icon-zuixiaohua-').hide();
                $('i.icon-zhankai').show();
            }

            function myShow() {
                $('.myself-videoBox').show();
                $('i.icon-zuixiaohua-').show();
                $('i.icon-zhankai').hide();
            }
        </script>
        <!-- 右上自己小分屏结束 -->
        <!-- 左上小分屏 -->
        <div class="onePeople">
            <div class="onePeople-videoBox">
                <!--<video src=""></video>-->
            </div>
        </div>
        <script>
            // var videoSrc = './images/2.mp4';
            // $('.onePeople-videoBox video').attr('src', videoSrc);
        </script>
        <!-- 左上小分屏结束 -->
        <!-- 1:7 -->
        <div class="videoList-1-7" id="videoBanner">
            <ul class="clearfix" id="otherVideo">
            </ul>
        </div>
        <!-- 1:7结束 -->

        <script>
            $(function () {
                $('.videoList-4').hide();
                $('.videoList-1-7').hide();
            })

            function bigVideo(videoId) {
                unFlex4();
                unVideo1I7();
                if ($('video.imageStyle').length > 0) {
                    if ($('video.videoStyle').length > 0) {
                        $('video.videoStyle').hide();
                        $('body').append($('video.videoStyle'));
                        $('video.videoStyle').removeClass('videoStyle');
                    }
                }
                $('.allVideo').each(function () {
                    if ($(this).attr('data-id') === videoId) {
                        $(this).show();
                        $(this).addClass('videoStyle');
                        $('.meeting-r-center').append($(this));
                    }
                });
            }

            // 放置 大屏
            function oneVideo() {
                if ($('video.videoStyle').length == 0) {
                    $('.allVideo').each(function (i) {
                        if (i == 0) {
                            $(this).show();
                            $(this).addClass('videoStyle');
                            $('.meeting-r-center').append($(this));
                        }
                    });
                }
            }

            // 放置 1:7
            function video1I7() {
                unVideo1I7()
                var bigId = $('.videoStyle').attr('data-id');
                if ($('.videoStyle').length > 0) {
                    $('.videoStyle').show();
                    $('.allVideo').each(function () {
                        if ($(this).attr('data-id') != bigId) {
                            $('#otherVideo').append($(this));
                            $(this).wrap('<li></li>');
                            $(this).show();
                        }
                    })
                } else {
                    $('.allVideo').each(function (i) {
                        if (i == 0) {
                            $(this).addClass('videoStyle');
                            $(this).show();
                            $('.meeting-r-center').append($(this));
                        } else {
                            $('#otherVideo').append($(this));
                            $(this).wrap('<li></li>');
                            $(this).show();
                        }
                    })
                }
                var Height = window.screen.availHeight * 0.8 * 0.9 * 0.19;
                var Width = window.screen.availWidth * 0.75 * 0.9 * 0.20;
                var str = '';
                $('#videoBanner li').css({
                    height: Height + 'px',
                    width: Width + 'px',
                })
                $('.videoStyle').css({
                    height: '80%'
                })
                $('.videoList-1-7').show();
            }

            // 取消 1：7
            function unVideo1I7() {
                var bigId = $('.videoStyle').attr('data-id');
                $('.allVideo').each(function () {
                    if ($(this).attr('data-id') == bigId) {
                        $(this).removeClass('videoStyle');
                        $('body').append($(this));
                        $(this).hide();
                    } else {
                        $(this).unwrap();
                        $('body').append($(this));
                        $(this).hide();
                    }
                    $('.videoList-1-7').hide();
                })
            }

            // 4分屏
            // flex4()
            function flex4() {
                if ($('video.videoStyle').length > 0) {
                    $('video.videoStyle').hide();
                    $('body').append($('video.videoStyle'))
                    $('video.videoStyle').removeClass('videoStyle');
                }
                $('.videoList-4').show();
                $('.allVideo').each(function (i) {
                    if (i <= 3) {
                        $('.videoList-4 ul').append($(this));
                        $(this).wrap('<li></li>');
                        $(this).show();
                    }else{
                        $(this).hide();
                    }
                })
            }

            // 取消 4分屏
            // unFlex()
            function unFlex4() {
                $('.videoList-4 .allVideo').each(function (i) {
                    $(this).unwrap();
                    $('body').append($(this));
                    $(this).hide();
                });
                $('.videoList-4').hide();
            }
        </script>
        <!-- 下边菜单 -->
        <div class="right-footer">
            <!-- 左侧图标开始 -->
            <div class="right-icons right-icons-l fl" data-uk-offcanvas="{target:'#drawer'}">
                <div id="closeL" class="right-icons-container" title="隐藏状态栏">
                    <i class="iconfont icon-jiantouarrowhead7 right-fonts"></i>
                </div>
                <div id="openL" class="right-icons-container btn-hidden" title="显示状态栏">
                    <i class="iconfont icon-jiantouarrow487 right-fonts"></i>
                </div>
            </div>
            <!-- 左侧图标结束 -->
            <!-- 中间图标开始 -->
            <div class="right-icons right-icons-c fl">
                <div class="right-icons-container icon-margin-r" title="静音麦克风" id="muteBtn">
                    <i class="iconfont icon-maikefeng right-fonts"></i>
                </div>
                <div class="right-icons-container icon-margin-r" title="禁用摄像头" id="cameraCloseBtn">
                    <i class="iconfont icon-shexiangtou_shiti right-fonts"></i>
                </div>
                <!--<div class="right-icons-container icon-margin-r" style="background:#09b708;" id="EnterBtn" title="连接会议">-->
                <!--<i class="iconfont icon-jinru right-fonts"></i>-->
                <!--</div>-->
                <div class="right-icons-container icon-margin-r dianhuared" id="disconnectBtn" title="断开">
                    <i class="iconfont icon-phonedianhua right-fonts"></i>
                </div>
                <div class="right-icons-container icon-margin-r" id="shareDesktopBtn" title="开启桌面共享">
                    <i class="iconfont icon-yunzhuomian right-fonts"></i>
                </div>
                <div class="right-icons-container icon-margin-r"
                     data-uk-modal="{target:'#shareDocModal',bgclose:false,center:true}" id="shareDocBtn" title="分享">
                    <i class="iconfont icon-tupian right-fonts"></i>
                </div>
                <div class="right-icons-container" title="更多" id="moreBtn">
                    <i class="iconfont icon-shenglvehao right-fonts"></i>
                </div>
            </div>
            <!-- 中间图标结束 -->
            <!-- 右侧图标开始 -->
            <div class="right-icons right-icons-r fr">
                <!-- 音视频统计 -->
                <div class="right-icons-container xinxi-icon" title="音视频统计" id="tongjiBtn">
                    <i class="iconfont icon-xinxi right-fonts"></i>
                </div>
                <!-- 全屏 -->
                <div class="right-icons-container" title="全屏" id="quanpingBtn">
                    <i class="iconfont icon-fangda right-fonts"></i>
                </div>
            </div>
            <!-- 右侧图标结束 -->
        </div>
        <!-- 分屏选项开始 -->
        <div class="fenping-container" id="fenpingContainer">
            <div>
                布局
            </div>
            <div class="fenping-items" id="1screen" onclick="screen1()">
                <img src="./images/1click.png" alt="1大屏" class="fenping-img">
                <p class="fenping-des">1大屏</p>
            </div>
            <div class="fenping-items" id="4screen" onclick="screen4()">
                <img src="./images/4screen.png" alt="4分屏" class="fenping-img">
                <p class="fenping-des">4分屏</p>
            </div>
            <div class="fenping-items" id="8screen" onclick="screen17()">
                <img src="./images/8screen.png" alt="1+7分屏" class="fenping-img">
                <p class="fenping-des">1+7</p>
            </div>

        </div>
        <script>
            function screen1() {
                sendLayout(1);
                unFlex4();
                unVideo1I7();
                oneVideo();
            }

            function screen4() {
                sendLayout(4);
                unVideo1I7();
                flex4();
            }

            function screen17() {
                sendLayout(17);
                unFlex4();
                video1I7()
            }

            function sendLayout(layout) {
                ws.send({
                    action: 'webrtc',
                    event: 'roomLayout',
                    mine: {
                        id: localUserId
                    },
                    room: {
                        id: roomId,
                    },
                    layout: layout
                });
            }

        </script>
        <!-- 分屏选项开始 -->

        <!-- 分享文件弹窗开始 -->
        <div id="shareDocModal" class="uk-modal">
            <div class="uk-modal-dialog share-dialog">
                <a class="uk-modal-close uk-close"></a>
                <div class="uk-modal-header">选择分享内容</div>
                <div class="share-container">
                    <div class="share-item" id="shareImgBtn">
                        <input type="file" id="imgInp" accept="image/*" class="share-input">
                        <img src="./images/shareImg.png" class="share-img" alt="">
                        <p class="share-title">图片</p>
                    </div>
                    <div class="share-item">
                        <input type="file" id="pdfInp" accept=".pdf" class="share-input">
                        <img src="./images/sharePDF.png" class="share-img" alt="">
                        <p class="share-title">PDF</p>
                    </div>
                </div>
                <div class="uk-modal-footer uk-text-right">
                    <button type="button" id='shareCancelBtn' class="uk-button share-cancel-btn">取消</button>
                </div>
            </div>
        </div>
        <!-- 下边菜单结束 -->
        <!-- 修改昵称弹窗开始 -->
        <div id="gaimingModal" class="uk-modal">
            <div class="uk-modal-dialog gmdialog">
                <a class="uk-modal-close uk-close"></a>
                <div class="uk-modal-header gmHeader">修改显示姓名</div>
                <div class="gmForm">
                    <input type="text" name="" id="gmValue" class="gmInp" placeholder="请输入新昵称">
                </div>
                <div class="uk-modal-footer gmFooter">
                    <button type="button" id='gaimingSubBtn' class="uk-button gmdlgBtn gmSubBtn">确定</button>
                    <button type="button" id='gaimingCancelBtn' class="uk-button gmdlgBtn gmCancelBtn">取消</button>
                </div>
            </div>
        </div>
        <!-- 修改昵称弹窗结束 -->
        <!-- 音视频统计弹窗 start -->
        <div class="uk-animation-scale-up BigTable">
            <div>
                <table>
                    <tbody id="tongjiList">
                    <!--<tr>-->
                        <!--<th>名称</th>-->
                        <!--<th>通道</th>-->
                        <!--<th>编码器</th>-->
                        <!--<th>分辨率</th>-->
                        <!--<th>帧率</th>-->
                        <!--<th>码率</th>-->
                        <!--<th>丢包率</th>-->
                    <!--</tr>-->
                    </tbody>
                </table>
            </div>
        </div>
        <!-- 音视频统计弹窗 end -->
        <!-- 视频弹出层start -->
        <div class="uk-animation-scale-up videoDialog" id="videoDialogPopup">
            <div class="videoDialog-header">
                <i class="iconfont icon-guanbi video-exit-icon" id="cancelVioDlgBtn"></i>
            </div>
            <div class="videoDialog-container">
                <video src="" id="dialogVideo" class="dialogVideo" playsinline autoplay muted></video>
            </div>
        </div>
        <!-- 视频弹出层end -->
    </div>
</div>

<script>
    var localUserId = null;
    var userName = null;
    var roomId = null;
    var pwd = null;
    var roomInfo = null;
    var ws = null;
    var isAudio = true; // false静音
    var isAllMute = true; //全体静音

    $(function () {
        roomInfo = JSON.parse(localStorage.getItem('roomInfo')) || {};
        localUserId = roomInfo.userId || null;
        userName = roomInfo.userName || null;
        roomId = roomInfo.roomId || null;
        pwd = roomInfo.psw || null;
        setUpFullScreen();

        // 开启视频
        let videoOptions = JSON.parse(localStorage.getItem('setOptions')) || {};
        startWebRTC(localUserId, roomId, roomInfo, true, false, videoOptions);

        $('#menuBtn').hide();

        // ws事件
        if (localUserId || userName || roomId || pwd) {
            // 开启ws
            WS.prototype.open = function (e) {
                this.send({
                    action: 'open',
                    webrtc: {
                        id: localUserId
                    },
                    info: {
                        id: localUserId,
                        name: userName,
                    }
                });
            };

            WS.prototype.actionOpen = function (e) {

            };

            WS.prototype.joined = function (data) {
                for (let k in data.roomInfo) {
                    roomInfo[k] = data.roomInfo[k];
                }
                roomInfo.userCount = data.userCount;

                // 房间信息
                $('#roomNum').text(roomInfo.roomId);
                $('#userNum').text(`—— 共${roomInfo.userCount}人`);
                $('#roomName').text(roomInfo.name);
                if (localUserId == roomInfo.owner) {
                    $('#menuBtn').show();
                } else {
                    $('#menuBtn').hide();
                }
                // 设置userInfo
                if (data.userInfo || data.userInfo.length > 0) {
                    $('#userList').empty();
                    setRoomUser(data.userInfo);
                }
            };


            WS.prototype.otherJoin = function (data) {
                // 设置userInfo
                if (data.userInfo && data.userInfo.length > 0) {
                    $('#userList').empty();
                    let len = data.userInfo.length;
                    $('#userNum').text(`—— 共${len}人`);
                    if(0 < len <=2 ){
                        screen1();
                    } else if(2 < len <= 5) {
                        screen4();
                    } else if(5 < len <= 8){
                        screen17();
                    }
                    setRoomUser(data.userInfo);
                }
                // 创建 peerConnect
                cleanOneUser(data.from.id);
                createPeerConnection(data.from.id);
                createDataChannel(data.from.id);
                createOffer(data.from.id);
            };

            WS.prototype.offer = function (data) {
                cleanOneUser(data.from.id);
                createPeerConnection(data.from.id);
                setRemoteDesc(data.from.id, data.data);
                createAnswer(data.from.id);
            };

            WS.prototype.answer = function (data) {
                setRemoteDesc(data.from.id, data.data);
            };

            WS.prototype.candidate = function (data) {
                addIceCandidate(data.from.id, data.data);
            };

            function muteDisable (data){
                // 访客不可点击自己静音
                if(data.auth){
                    $('#muteBtn').addClass('disAble');
                    isAudio = false;
                    muteHandle(isAudio);
                }else{
                    $('#muteBtn').removeClass('disAble');
                    isAudio = true;
                    muteHandle(isAudio);
                }
            }

            // 全体静音
            WS.prototype.muteAudio = function (data) {
                muteUserAudio(!data.auth);
                muteDisplayAudio(!data.auth);
                if(data.auth){
                    $('#muteBtn').addClass('disAble');
                    isAudio = false;
                    muteHandle(isAudio);
                }else{
                    $('#muteBtn').removeClass('disAble');
                    isAudio = true;
                    muteHandle(isAudio);
                }
                console.log(data);
                isAllMute = data.auth;
                $('.voice').each(function (){
                    var uuId = $(this).parent().attr('data-id');
                    if(uuId != roomInfo.owner){
                        if (isAllMute) {
                            $(this).removeClass('icon-maikefeng-tianchong').addClass('icon-maikefeng-jingyin').addClass('redColor');
                        } else {
                            $(this).removeClass('icon-maikefeng-jingyin').removeClass('redColor').addClass('icon-maikefeng-tianchong');
                        }
                    }
                })
            };

            // 用户静音
            WS.prototype.userAudio = function (data) {
                muteUserAudio(!data.auth);
                muteDisplayAudio(!data.auth);
                if(data.auth){
                    $('#muteBtn').addClass('disAble');
                    isAudio = false;
                    muteHandle(isAudio);
                }else{
                    $('#muteBtn').removeClass('disAble');
                    isAudio = true;
                    muteHandle(isAudio);
                }
                console.log($('.voice'))
                $('.voice').each(function (){
                    var uuId = $(this).parent().attr('data-id');
                    console.log(uuId, data.room.id)
                    if(uuId == data.room.id){
                        if (data.auth) {
                            $(this).removeClass('icon-maikefeng-tianchong').addClass('icon-maikefeng-jingyin').addClass('redColor');
                        } else {
                            $(this).removeClass('icon-maikefeng-jingyin').removeClass('redColor').addClass('icon-maikefeng-tianchong');
                        }
                    }
                })
            };

            // 设置管理者
            WS.prototype.setAdmin = function (data) {
                setRoomUser(setRoomUserF, data.admin.id);
            };

            // 取消管理者
            WS.prototype.cancelAdmin = function (data) {
                setRoomUser(setRoomUserF);
            };

            // 布局
            WS.prototype.roomLayout = function (data) {
                let layout = data.layout; // 1 4 17
            };

            // 最大视频的人
            WS.prototype.maxVideo = function (data) {
                // 判断中间是否有视频
                if (localUserId != data.maxVideoId) {
                    if ($('video.videoStyle').length > 0) {
                        $('video.videoStyle').each(function () {
                            $(this).removeClass('videoStyle');
                            $('body').append($(this));
                        });
                    } else if ($('img.imageStyle').length > 0) {
                        $('img.imageStyle').each(function () {
                            $(this).remove();
                        });
                    } else if ($('object.videoStyle').length > 0) {
                        $('object.videoStyle').each(function () {
                            $(this).remove();
                        });
                    }
                    bigVideo(data.maxVideoId);
                }
            };


            // 修改名称
            WS.prototype.editName = function (data) {
                if (data.webrtc.id) {
                    let roomUserId = setRoomUserId(data.webrtc.id);
                    $(`#${roomUserId} span.itemName`).text(data.webrtc.name);
                }
            };

            WS.prototype.removeUser = function (data) {
                let removeUserId = data.webrtc.id;
                $(`#${removeUserId}`).remove();
                let roomUserId = setRoomUserId(removeUserId);
                $(`#${roomUserId}`).remove();
                cleanOneUser(data.from.id);
                if (removeUserId === localUserId) {
                    UIkit.notify("您已被移出会议室!!!", {
                        status: 'success',
                        timeout: 1000
                    });
                    setTimeout(function () {
                        ws.close();
                        window.location.href = 'index.html';
                    }, 500);
                }
            };

            // 关闭房间
            WS.prototype.closeRoom = function (data) {
                ws.close();
                window.location.href = 'index.html';
            };

            // 用户退出
            WS.prototype.out = function (data) {
                unFlex4();
                unVideo1I7();
                let roomUserId = setRoomUserId(data.from.id);
                $(`#${roomUserId}`).remove();
                cleanOneUser(data.from.id);
            };

            // 开启ws
            ws = new WS();
        }


        var deviceWidth = document.documentElement.clientWidth;
        document.documentElement.style.fontSize = deviceWidth / 13.36 + 'px';
        $('#closeL').on('click', function () {
            var left = 0;
            var timer = 0;
            timer = setInterval(function () {
                if (left < 25) {
                    left += 1;
                    $('.meeting-l').css({
                        left: '-' + left + '%'
                    });
                    $('.meeting-r').css({
                        left: (25 - left) + '%',
                        width: (75 + left) + '%'
                    });
                } else {
                    clearInterval(timer);
                }
            }, 20);
            $('#closeL').css('display', 'none');
            $('#openL').css('display', 'block')
        });
        $('#openL').on('click', function () {
            var left = -25;
            var timer = 0;
            timer = setInterval(function () {
                if (left < 0) {
                    left += 1;
                    $('.meeting-l').css({
                        left: left + '%'
                    })
                    $('.meeting-r').css({
                        left: (25 + left) + '%',
                        width: (75 - left) + '%'
                    })
                } else {
                    clearInterval(timer);
                }
            }, 20);
            $('#openL').css('display', 'none');
            $('#closeL').css('display', 'block');
        });
        /* 图标区域 */
        /* **************点击静音麦克风************** */
        if (localStream.user) {
            isAudio = localStream.user.getAudioTracks()[0].enabled;
        } else if (localStream.display) {
            isAudio = localStream.display.getAudioTracks()[0].enabled;
        }
        muteHandle(isAudio);

        function muteHandle(isAudio) {
            if (isAudio) {
                $('#muteBtn').attr('title', '静音麦克风').children('.icon-maikefeng-jingyin').removeClass('icon-maikefeng-jingyin').addClass('icon-maikefeng').removeClass('redColor');
            } else {
                $('#muteBtn').attr('title', '取消静音').children('.icon-maikefeng').addClass('redColor').removeClass('icon-maikefeng').addClass('icon-maikefeng-jingyin');
            }
        }

        $('#muteBtn').click(() => {
            isAudio = !isAudio;
            muteHandle(isAudio);
            muteUserAudio(isAudio);
            muteDisplayAudio(isAudio);
        });

        /* **************点击禁用摄像头************** */
        var isVideo = true;
        if (localStream.user) {
            isVideo = localStream.user.getVideoTracks()[0].enabled;
        } else if (localStream.display) {
            isVideo = localStream.display.getVideoTracks()[0].enabled;
        }
        videoHandle(isVideo);

        function videoHandle(isVideo) {
            if (isVideo) {
                $('#cameraCloseBtn').attr('title', '禁用摄像头').children('.icon-video-off').removeClass('icon-video-off').addClass('icon-shexiangtou_shiti')
            } else {
                $('#cameraCloseBtn').attr('title', '启用摄像头').children('.icon-shexiangtou_shiti').removeClass('icon-shexiangtou_shiti').addClass('icon-video-off')
            }
        }

        function openClose(a, b) {
            if ($(a).length > 0) {
                $(b).removeClass('redColor');
            } else {
                $(b).addClass('redColor');
            }
        }

        $('#cameraCloseBtn').click(() => {
            openClose('#cameraCloseBtn i.redColor', '#cameraCloseBtn i');
            isVideo = !isVideo;
            videoHandle(isVideo);
            muteUserVideo(isVideo);
            muteDisplayVideo(isVideo);

        });

        /* **************点击挂断************** */
        $('#disconnectBtn').click(() => {
            var r = confirm("是否确认离开会议室");
            if (r == true) {
                ws.close();
                stopUserTrack();
                stopDisplayTrack();
                // 跳转
                location.href = "index.html";
            }
        });

        /* **************点击开启桌面共享************** */
        $('#shareDesktopBtn').click(function () {
            openClose('#shareDesktopBtn i.redColor', '#shareDesktopBtn i');

            if ($(this).attr('title') === '开启桌面共享') {
                document.getElementById('localVideoSmall').srcObject = null;
                startWebRTC(localUserId, roomId, roomInfo, false, true, videoOptions);

            } else {
                document.getElementById('localVideoSmall').srcObject = null;
                startWebRTC(localUserId, roomId, roomInfo, true, false, videoOptions);
            }
        });

        /* **************分享文件************** */
        let shareModal = UIkit.modal("#shareDocModal");
        $('#shareDocModal').on({
            'show.uk.modal': function(){
                $('#fenpingContainer').hide();
                console.log("Modal is visible.");
            }
        });
        // 取消按钮
        $('#shareCancelBtn').click(() => {
            shareModal.hide();
        })
        // 点击上传图片
        $('#imgInp').change(function () {
            let file = $(this)[0].files[0];
            if(file){
                let ext = getFileExt(file.name);
                if( ['png', 'jpeg', 'jpg', 'gif'].includes(ext) ){
                    sendF(file, 1);
                } else {
                    UIkit.notify("上传图片格式为[png/jpeg/jpg/gif]!", {
                        status: 'error',
                        timeout: 1000
                    });
                }
            }

        });

        // 点击上传pdf
        $('#pdfInp').change(function () {
            let file = $(this)[0].files[0];
            if(file){
                let ext = getFileExt(file.name);
                if( ['pdf'].includes(ext) ){
                    sendF(file, 2);
                } else {
                    UIkit.notify("上传pdf文件!", {
                        status: 'error',
                        timeout: 1000
                    });
                }
            }
        });


        function sendF(file, num) {
            // 上传大于10M
            if ( file.size <= 0 ) {
                return;
            }
            if(file.size > 1024 * 1024 * 10){
                alert('长传文件不能超过10M!!!');
            }
            sendChannelData({
                hasFile: true,
                // fileId: 'file_' + localUserId,
                fileSize: file.size,
                fileName: file.name,
                fileType: file.type
            }, 'json');
            var buffers = [];
            var chunks = 0;
            sendFiles(file, (buffer) => {
                buffers.push(buffer);
                chunks += buffer.byteLength;
                if (chunks === file.size) {
                    let received = new Blob(buffers, {type: file.type});
                    let href = URL.createObjectURL(received);
                    var ppp = $('.meeting-r-center video.videoStyle');
                    if (ppp.length > 0) {
                        ppp.removeClass('videoStyle');
                        $('.onePeople-videoBox').append(ppp);
                    }
                    unFlex4();
                    unVideo1I7();
                    if ($('img.imageStyle').length > 0) {
                        $('img.imageStyle').remove()
                    }
                    if ($('object.videoStyle').length > 0) {
                        $('object.videoStyle').remove()
                    }
                    if (num == 1) {
                        var str = `
                            <img src="${href}" class="imageStyle" />
                        `;
                        $('.meeting-r-center').append(str);
                    } else if (num == 2) {
                        var str = `
                            <object data="${href}" class="videoStyle"></object>
                        `;
                        $('.meeting-r-center').append(str);
                    }
                }
            }, () => {
                buffers = [];
                chunks = 0;
                $('#imgInp').val('');
                $('#pdfInp').val('');
            });
            // 关闭模态框
            shareModal.hide()
        }

        /* **************分屏开始************** */
        // 点击更多按钮显示隐藏fenpingContainer
        $('#moreBtn').click(() => {
            if ($('.meeting-r-center img').length > 0 || $('.meeting-r-center object').length > 0) {
                return;
            }
            if ($('#fenpingContainer').css('visibility') === 'hidden' ? true : false) {
                $('#fenpingContainer').css('visibility', 'visible')
            } else {
                $('#fenpingContainer').css('visibility', 'hidden')
            }
        })
        // 点击1大屏切换图片
        $('#1screen').click(() => {
            $('#1screen').find("img").eq(0).attr('src', './images/1screen.png');
            $('#4screen').find("img").eq(0).attr('src', './images/4screen.png');
            $('#8screen').find("img").eq(0).attr('src', './images/8screen.png');
            $('#1screen').find("img").eq(0).attr('src', './images/1click.png');
        })
        // 点击4大屏切换图片
        $('#4screen').click(() => {
            $('#1screen').find("img").eq(0).attr('src', './images/1screen.png');
            $('#4screen').find("img").eq(0).attr('src', './images/4screen.png');
            $('#8screen').find("img").eq(0).attr('src', './images/8screen.png');
            $('#4screen').find("img").eq(0).attr('src', './images/4click.png');
        })
        // 点击1+7大屏切换图片
        $('#8screen').click(() => {
            $('#1screen').find("img").eq(0).attr('src', './images/1screen.png');
            $('#4screen').find("img").eq(0).attr('src', './images/4screen.png');
            $('#8screen').find("img").eq(0).attr('src', './images/8screen.png');
            $('#8screen').find("img").eq(0).attr('src', './images/8click.png');
        })


        /* **************音视频统计开始************** */
        $('.BigTable').hide();
        var clearSet = null;
        $('#tongjiBtn').on('click', function(){
            openClose('#tongjiBtn i.redColor', '#tongjiBtn i');

            if($('.BigTable').css('display') == 'none'){
                $('.BigTable').show();
                prevLocalInfo = {};
                prevRemoteInfo = {};
                clearSet = setInterval(function () {
                    streamState();
                    setTimeout(function () {
                        setRoomTJ(streamInfo);
                    }, 500);
                }, 1000);
            }else if ($('.BigTable').css('display') == 'block'){
                $('.BigTable').hide();
                clearInterval(clearSet);
            }
        });

        function setRoomTJ(dataList) {
            $('#tongjiList').empty().append(`
                    <tr>
                        <th>名称</th>
                        <th>通道</th>
                        <th>编码器</th>
                        <th>分辨率</th>
                        <th>帧率</th>
                        <th>码率</th>
                        <th>丢包率</th>
                    </tr>
                `);
            let dataListLen = dataList.length;
            let setRoomUserFLen = setRoomUserF.length;
            for (let i = 0; i < dataListLen; ++i){
                for (let j = 0; j < setRoomUserFLen; ++j){
                    if(setRoomUserF[j].id === dataList[i].userId){
                        $('#tongjiList').append(`
                            <tr>
                                <td>${dataList[i].source === '远程' ?  setRoomUserF[j].name : dataList[i].source}</td>
                                <td>${dataList[i].source === '本地' ? '视频发送' : '视频接收'}</td>
                                <td>${dataList[i].mediaType}</td>
                                <td>${dataList[i].width}x${dataList[i].height}</td>
                                <td>${parseInt(dataList[i].framesSent)}</td>
                                <td>${parseInt(dataList[i].bitrate)}kbps</td>
                                <td>${(dataList[i].packetsLost * 100).toFixed(5)}%</td>
                            </tr>
                        `);
                        break;
                    }
                }
            }
        }
        /* **************音视频统计结束 end************** */

        /* **************点击全屏按钮开始************** */
        // 全屏
        function fullScreen() {
            let res = isFullScreen();
            if (res) {
                document.cancelFullScreen();
            } else {
                document.body.requestFullScreen();
            }
            return res;
        }


        function isFullScreen() {
            if (isChromeApp()) {
                return chrome.app.window.current().isFullscreen();
            }
            return !!(document.webkitIsFullScreen || document.mozFullScreen || document.isFullScreen);
        }

        function isChromeApp() {
            return typeof chrome !== "undefined" && typeof chrome.storage !== "undefined" && typeof chrome.storage.local !== "undefined";
        }


        function setUpFullScreen() {
            if (isChromeApp()) {
                document.cancelFullScreen = function() {
                    chrome.app.window.current().restore();
                };
            } else {
                document.cancelFullScreen = document.webkitCancelFullScreen || document.mozCancelFullScreen || document.cancelFullScreen;
            }
            if (isChromeApp()) {
                document.body.requestFullScreen = function() {
                    chrome.app.window.current().fullscreen();
                };
            } else {
                document.body.requestFullScreen = document.body.webkitRequestFullScreen || document.body.mozRequestFullScreen || document.body.requestFullScreen;
            }
            document.onfullscreenchange = document.onfullscreenchange || document.onwebkitfullscreenchange;
        }


        $('#quanpingBtn').click(function () {
            if ($(this).attr('title') === '全屏') {
                $(this).attr('title', '取消全屏').children('.icon-fangda').removeClass('icon-fangda').addClass('icon-suoxiao')
                // FullScreen();
                fullScreen();
            } else {
                // exitFullScreen();
                fullScreen();
                $(this).attr('title', '全屏').children('.icon-suoxiao').removeClass('icon-suoxiao').addClass('icon-fangda')
            }
        });


        var setRoomUserF;
        function setRoomUser(userInfo, adminId = 0) {
            setRoomUserF = userInfo;
            $('#userList').empty();
            userInfo.forEach(function (item) {
                if (item || (item.id !== localUserId)) {
                    let roomUserId = setRoomUserId(item.id);
                    $('#userList').append(`
                        <li id="${roomUserId}" data-id="${item.id}">
                            <i class="iconfont icon-icontouxiang-copy avatar"></i>
                            <span ${(item.id === roomInfo.owner) ? '' : 'class="dis-n"'}>创始人</span>
                            <span class="itemName"> ${(item.id !== roomInfo.owner) ? item.name : ''}</span>
                            <span> ${(item.id === roomInfo.owner) || (localUserId === adminId && item.id === adminId) || (item.id === adminId) ? '主持人' : '访客'}</span>
                            <em ${(item.id === localUserId) ? '' : 'class="dis-n"'}>（我）</em>
                            <i ${(item.id !== localUserId) ? 'class="iconfont icon-ai224 fr more videoPopup"' : 'class="dis-n"'} title="弹出视频"></i>
                            <i ${(localUserId === roomInfo.owner) || (localUserId === adminId) ? 'class="iconfont icon-gengduo fr more shezhigengduo"' : 'class="dis-n"'} title="设置更多"></i>
                            <i ${(localUserId === roomInfo.owner) || (localUserId === adminId) ? 'class="iconfont icon-maikefeng-tianchong fr voice"' : 'class="dis-n"'} title="静音${item.name}"></i>
                            <div ${(localUserId === roomInfo.owner) || (localUserId === adminId) ? 'class="setMore-dialog gengduoDialog"' : 'class="dis-n"'}>
                                <div class="setMore-item gaimingBtn">改名</div>
                                <div class="${(localUserId === roomInfo.owner) && (item.id !== roomInfo.owner) ? 'setMore-item yichuBtn' : 'setMore-item dis-n yichuBtn'}">移除</div>
                                <div class="${(localUserId === roomInfo.owner) && (item.id !== roomInfo.owner) && (item.id !== adminId) ? 'setMore-item addAdminC' : 'setMore-item addAdminC dis-n'}" data-id="${item.id}">设为主持人</div>
                                <div class="${(localUserId === roomInfo.owner) && (item.id !== roomInfo.owner) && (item.id === adminId) ? 'setMore-item cancelAdminC' : 'setMore-item cancelAdminC dis-n'}" data-id="${item.id}">取消主持人</div>
                            </div>
                        </li>
                    `);
                }
            });
        }

        // 点击弹出视频按钮
        $('#userList').on('click', '.videoPopup', function () {
            let removeUserId = $(this).parents('li').attr('data-id');
            if ($('#videoDialogPopup').css('z-index') < 0) {

                $(this).addClass('redColor');
                openVideoDialog(removeUserId);
            } else {
                $(this).removeClass('redColor');
                closeVideoDialog();
            }
        });

        // 弹出视频关闭按钮
        $('#cancelVioDlgBtn').click(function () {
            $('.videoPopup').removeClass('redColor')
            closeVideoDialog();
        });

        function openVideoDialog(removeUserId) {
            $('#videoDialogPopup').css('z-index', '9999').fadeIn();

            getReceivers(remotePeer[removeUserId], (stream)=>{
                document.getElementById('dialogVideo').srcObject = stream;
            });

        }

        function closeVideoDialog(){
            $('#videoDialogPopup').css('z-index', '-100').fadeOut();
            document.getElementById('dialogVideo').srcObject = null;
        }




        $('#userList').on('click', '.addAdminC', function () {
            var adminId = $(this).attr('data-id');
            ws.send({
                action: 'webrtc',
                event: 'setAdmin',
                mine: {
                    id: localUserId
                },
                room: {
                    id: roomId,
                },
                admin: {
                    id: adminId
                }
            });
        });
        $('#userList').on('click', '.cancelAdminC', function () {
            var adminId = $(this).attr('data-id')
            ws.send({
                action: 'webrtc',
                event: 'cancelAdmin',
                mine: {
                    id: localUserId
                },
                room: {
                    id: roomId,
                },
                admin: {
                    id: adminId
                }
            });

        });

        $('#userList').on('click', '.avatar', function () {
            if (localUserId !== roomInfo.owner) {
                return;
            }
            let maxVideoId = $(this).parent().attr('data-id');
            // unFlex4();
            // unVideo1I7();
            // 判断中间是否有图片
            var isImg = $('img.imageStyle');
            if (isImg.length > 0) {
                isImg.remove();
            }
            // 判断中间是否有pdf
            if ($('object').length > 0) {
                $('object').remove();
            }
            pdfEnd();
            // 判断中间是否有视频
            if (localUserId != maxVideoId) {
                if ($('video.videoStyle').length > 0) {
                    $('video.videoStyle').each(function () {
                        $(this).removeClass('videoStyle');
                        $('body').append($(this));
                        $(this).hide();
                    });
                }
                bigVideo(maxVideoId);
            }
            // 判断左上方的小屏
            if ($('.onePeople-videoBox video').length > 0) {
                $('.onePeople-videoBox video').each(function () {
                    $('body').append($(this))
                });
            }
            ws.send({
                action: 'webrtc',
                event: 'maxVideo',
                mine: {
                    id: localUserId
                },
                room: {
                    id: roomId,
                },
                maxVideoId: maxVideoId
            });
        });


        // 设置更多按钮
        $('#userList').on('click', '.shezhigengduo', function () {
            if ($(this).nextAll('.gengduoDialog').css('display') === 'none') {
                $('#userList').find('.gengduoDialog').hide()
                $(this).nextAll('.gengduoDialog').show();
            } else {
                $(this).nextAll('.gengduoDialog').hide();
            }
        })


        // 移除按钮
        $('#userList').on('click', '.yichuBtn', function () {
            let removeUserId = $(this).parents('li').attr('data-id');
            var r = confirm("您确实想移除他吗？");
            if (r == true) {
                ws.send({
                    action: 'webrtc',
                    event: 'removeUser',
                    mine: {
                        id: localUserId
                    },
                    room: {
                        id: roomId,
                    },
                    webrtc: {
                        id: removeUserId
                    }
                });
            }
            $(this).parent().hide();
        })

        var gmUserId = '';
        // 改名按钮
        $('#userList').on('click', '.gaimingBtn', function () {
            $(this).parent().hide();
            gmUserId = $(this).parents('li').attr('data-id');
            UIkit.modal("#gaimingModal").show();
        })
        // 改名确定按钮
        $('#gaimingSubBtn').click(function () {
            let val = $('#gmValue').val(); // 新名字
            if (val && gmUserId) {
                ws.send({
                    action: 'webrtc',
                    event: 'editName',
                    mine: {
                        id: localUserId
                    },
                    room: {
                        id: roomId
                    },
                    webrtc: {
                        id: gmUserId,
                        name: val
                    },

                });
            }
            UIkit.modal("#gaimingModal").hide();
        });

        // 改名取消按钮
        $('#gaimingCancelBtn').click(function () {
            UIkit.modal("#gaimingModal").hide();
        });

        //静音按钮
        // var isUserAudioFlag = true;
        $('#userList').on('click', '.voice', function () {
            if (isAudio) {
                $(this).removeClass('icon-maikefeng-tianchong').addClass('icon-maikefeng-jingyin').addClass('redColor');
            } else {
                $(this).removeClass('icon-maikefeng-jingyin').removeClass('redColor').addClass('icon-maikefeng-tianchong');
            }
            let userAudioId = $(this).parents('li').attr('data-id');
            ws.send({
                action: 'webrtc',
                event: 'userAudio',
                mine: {
                    id: localUserId
                },
                room:{
                    id: roomId
                },
                webrtc: {
                    id: userAudioId  // 用户id
                },
                auth: isAudio // true静音/false取消静音
            });
            isAudio = !isAudio;
        });

        function setRoomUserId(userId) {
            return 'roomUser_' + userId;
        }
    })

</script>
<script src="js/webrtc/adapter-latest.js"></script>
<script src="js/webrtc/webSocketEvent.js"></script>
<script src="js/webrtc.js"></script>
<script src="js/webrtc/ga.js"></script>
</body>

</html>